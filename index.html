<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Hành Trình Giọt Đỏ Yêu Thương</title>
<style>
 body{background:#ffe6e6;text-align:center;font-family:Arial,sans-serif;margin:0;}
 header{display:flex;align-items:center;gap:10px;padding:10px;}
 header img{width:120px;height:120px;border-radius:50%;object-fit:cover;}
 h1{color:darkred;margin:0 auto;}
 canvas{border:3px solid darkred;background:linear-gradient(#fff0f0,#ffe6e6);box-shadow:0 0 20px red;border-radius:10px;margin-top:10px;}
 #score{font-size:24px;margin-top:10px;color:darkred;font-weight:bold;}
 #gameOver{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);color:white;font-size:24px;justify-content:center;align-items:center;flex-direction:column;z-index:10;}
 button{padding:8px 16px;font-size:18px;border:none;border-radius:6px;background:#ff4444;color:white;cursor:pointer;}

@media (hover:hover){#mobileControls{display:none;}}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="CLB Hiến Máu">
  <h1>❤️ Hành Trình Giọt Đỏ Yêu Thương ❤️</h1>
</header>

<!-- Start Screen -->
<div id="startScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:20;color:white;">
  <div style="background:#fff;padding:20px 30px;border-radius:8px;text-align:center;color:#333;max-width:90%%;">
    <h2>Nhập tên của bạn để bắt đầu</h2>
    <input id="playerNameInput" type="text" placeholder="Tên của bạn" style="padding:8px;font-size:18px;width:80%%;max-width:300px;border-radius:4px;border:1px solid #ccc;">
    <br><br>
    <button onclick="startGame()" style="padding:10px 24px;font-size:18px;border:none;border-radius:6px;background:#e53935;color:white;cursor:pointer;">Bắt đầu chơi</button>
  </div>
</div>

<canvas id="gameCanvas" width="400" height="500"></canvas>

<!-- Mobile on-screen buttons -->
<div id="mobileControls" style="margin-top:14px;display:flex;justify-content:center;gap:40px;">
  <button id="btnLeft"  style="width:80px;height:80px;font-size:36px;border:none;border-radius:50%;background:#e74c3c;color:white;">◀︎</button>
  <button id="btnRight" style="width:80px;height:80px;font-size:36px;border:none;border-radius:50%;background:#e74c3c;color:white;">▶︎</button>
</div>

<div id="score">Điểm: 0</div>

<audio id="hitSound" src="hit.wav"></audio>
<audio id="bgMusic" src="journey.mp3" loop></audio>

<div id="gameOver"><div id="gameOverContent" style="text-align:center"></div></div>

<script>
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const hitSound=document.getElementById('hitSound');
const bgMusic=document.getElementById('bgMusic');

let bgStarted=false;
let playerName = localStorage.getItem('playerName') || '';
let giotMau={x:160,y:440,width:80,height:80};
let obstacles=[];
let score=0;
let obstacleSpeed=3;
let spawnInterval=1500;
let gameLoop,spawnLoop;

const imgBlood=new Image(); imgBlood.src='blood-drop.png';
const imgClot=new Image();  imgClot.src='clot.png';

function drawGiotMau(){ctx.drawImage(imgBlood,giotMau.x,giotMau.y,giotMau.width,giotMau.height);}
function drawObstacle(o){ctx.drawImage(imgClot,o.x,o.y,o.width,o.height);}

function update(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 drawGiotMau();
 obstacles.forEach((o,i)=>{
   o.y+=obstacleSpeed;
   drawObstacle(o);
   if(giotMau.x<o.x+o.width&&giotMau.x+giotMau.width>o.x&&giotMau.y<o.y+o.height&&giotMau.y+giotMau.height>o.y){ gameOver(); }
   if(o.y>canvas.height){
     obstacles.splice(i,1);
     score++;
     document.getElementById('score').innerText='Điểm: '+score;
     if(score%5===0){ obstacleSpeed+=0.5; if(spawnInterval>600){ clearInterval(spawnLoop); spawnInterval-=100; spawnLoop=setInterval(spawnObstacle,spawnInterval);} }
   }
 });
}

function spawnObstacle(){ const s=80; obstacles.push({x:Math.random()*(canvas.width-s),y:-s,width:s,height:s}); }

function gameOver(){
 clearInterval(gameLoop); clearInterval(spawnLoop);
 hitSound.play();
 document.getElementById('gameOver').style.display='flex';
 document.getElementById('gameOverContent').innerHTML=`<p style='color:yellow;font-size:32px;margin:0;'>Điểm của bạn: ${score}</p>
 <p style='margin:10px 0;'>${playerName}, cảm ơn bạn đã tham gia trò chơi!</p>
 <p style='font-style:italic;'>Một giọt máu cho đi, một cuộc đời ở lại – hãy hiến máu nhân đạo!</p>
 <button onclick='location.reload()'>Chơi lại</button>`;
 bgMusic.pause();
}

function start(){ gameLoop=setInterval(update,20); spawnLoop=setInterval(spawnObstacle,spawnInterval); }


window.addEventListener('keydown', e=>{
 if(e.key==='ArrowLeft'||e.key==='a'){ if(giotMau.x>0) giotMau.x-=30; }
 if(e.key==='ArrowRight'||e.key==='d'){ if(giotMau.x<canvas.width-giotMau.width) giotMau.x+=30; }
});
 bgStarted=true; start(); }
 if(e.key==='ArrowLeft'||e.key==='a'){ if(giotMau.x>0) giotMau.x-=30; }
 if(e.key==='ArrowRight'||e.key==='d'){ if(giotMau.x<canvas.width-giotMau.width) giotMau.x+=30; }
});

// ===== Mobile swipe controls =====
let touchStartX = null;
canvas.addEventListener('touchstart', e => {
  touchStartX = e.touches[0].clientX;
}, {passive:true});
canvas.addEventListener('touchend', e => {
  if (touchStartX === null) return;
  const dx = e.changedTouches[0].clientX - touchStartX;
  if (Math.abs(dx) > 30) {      // swipe threshold ~30px
    if (dx > 0 && giotMau.x < canvas.width - giotMau.width) giotMau.x += 30;
    if (dx < 0 && giotMau.x > 0) giotMau.x -= 30;
  }
  touchStartX = null;
}, {passive:true});
// ===== End mobile swipe controls =====

// On‑screen buttons for touch & mouse
['touchstart','mousedown'].forEach(evt=>{
 document.getElementById('btnLeft').addEventListener(evt, ()=>{
   if(giotMau.x>0) giotMau.x-=30;
 },{passive:true});
 document.getElementById('btnRight').addEventListener(evt, ()=>{
   if(giotMau.x<canvas.width-giotMau.width) giotMau.x+=30;
 },{passive:true});
});



// Auto start when playerName already saved (after reload)
window.addEventListener('DOMContentLoaded', () => {
  if (playerName) {
    document.getElementById('startScreen').style.display = 'none';
    if (!bgStarted) { bgMusic.play(); bgStarted = true; }
    startLoops();
  }
});

</script>
</body>
</html>
