<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <!-- Ngăn phóng to / zoom trên thiết bị di động -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0,
                 maximum-scale=1.0, user-scalable=no">
  <title>Hành Trình Giọt Đỏ</title>

  <style>
    /* ===== Reset & Base ===== */
    html,body{
      margin:0;padding:0;
      background:#ffe6e6;
      font-family:Arial,sans-serif;
      text-align:center;
      touch-action:manipulation;        /* chặn double-tap zoom */
      overscroll-behavior:none;
    }
    canvas{
      border:3px solid darkred;
      border-radius:10px;
      background:linear-gradient(#fff0f0,#ffe6e6);
      box-shadow:0 0 20px red;
      margin-top:10px;
    }
    #score,#gameOver{
      font-size:24px;
      margin-top:10px;
      color:darkred;
      font-weight:bold;
    }
    #gameOver{
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.75);
      color:#fff; z-index:10;
      padding:0 20px;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      text-align:center;
    }
    #startScreen{
      position:fixed; inset:0;
      background:rgba(0,0,0,.8);
      z-index:20; color:#fff;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
    }
    button,#btnLeft,#btnRight{
      padding:8px 16px; font-size:18px;
      border:none; border-radius:6px;
      background:#e53935; color:#fff;
      cursor:pointer; margin:10px;
      touch-action:manipulation; user-select:none;
    }
  </style>
</head>
<body>
  <!-- ===== Màn nhập tên ===== -->
  <div id="startScreen">
    <h2>Nhập tên của bạn để bắt đầu</h2>
    <input id="playerNameInput" placeholder="Tên của bạn"
           style="padding:8px;font-size:18px;width:80%;max-width:300px;
                  border-radius:4px;border:1px solid #ccc">
    <button id="startBtn">Bắt đầu chơi</button>
  </div>

  <!-- ===== Khu vực trò chơi ===== -->
  <canvas id="gameCanvas" width="400" height="500"></canvas>
  <div id="score">Điểm: 0</div>
  <div id="gameOver"></div>

  <!-- ===== Nút ảo cho mobile ===== -->
  <div id="mobileControls"
       style="margin-top:14px;display:flex;justify-content:center;gap:40px">
    <button id="btnLeft"  style="width:80px;height:80px;font-size:36px;border-radius:50%">◀︎</button>
    <button id="btnRight" style="width:80px;height:80px;font-size:36px;border-radius:50%">▶︎</button>
  </div>

  <!-- ===== Âm thanh ===== -->
  <audio id="hitSound" src="hit.wav"></audio>
  <audio id="bgMusic"  src="journey.mp3" loop></audio>

<script>
/* ==================== Hằng số & Tài nguyên ==================== */
const canvas   = document.getElementById('gameCanvas');
const ctx      = canvas.getContext('2d');
const scoreBox = document.getElementById('score');
const gOverBox = document.getElementById('gameOver');
const startScr = document.getElementById('startScreen');
const hitSound = document.getElementById('hitSound');
const bgMusic  = document.getElementById('bgMusic');

const bloodImg = new Image();
const clotImg  = new Image();
bloodImg.src = 'blood-drop.png';
clotImg.src  = 'clot.png';

const SIZE    = 110;
const START_X = 145;
const MAX_X   = 400 - SIZE;

/* ==================== Thông điệp động viên ==================== */
const messages=[
  "Bạn đã sưởi ấm thêm một trái tim!","Hiến máu – hành động nhỏ, ý nghĩa lớn!",
  "Mỗi giọt máu là một nụ cười trao đi!","Nhờ bạn, sự sống tiếp tục chảy!",
  "Cứu người đâu chỉ là lời nói – bạn đã hành động!","Một giọt hôm nay, vạn niềm vui mai sau!",
  "Sức mạnh yêu thương nằm trong huyết quản bạn!","Trao máu - Trao hi vọng!",
  "Bạn là anh hùng thầm lặng của bệnh nhân!","Từ trái tim đến trái tim – cảm ơn bạn!",
  "Kết nối sự sống bằng chính dòng máu bạn!","Cho đi để nhận lại nụ cười!",
  "Cảm ơn bạn, sự sống luôn cần bạn!","Hiến máu: hành động giản dị, giá trị vô biên!",
  "Bạn vừa viết tiếp câu chuyện diệu kỳ của sự sống!","Lan tỏa yêu thương, bắt đầu từ một giọt máu!",
  "Bạn và tôi – cùng xây nhịp cầu sự sống!","Thêm một giọt máu, thêm một cơ hội hồi sinh!",
  "Hiến máu hôm nay, khỏe mạnh hôm mai!","Máu bạn quý giá hơn vàng – cảm ơn!"
].sort(()=>Math.random()-0.5);
let msgIdx = +sessionStorage.getItem('msgIdx') || 0;
const nextMsg = () => {
  const m = messages[msgIdx % messages.length];
  sessionStorage.setItem('msgIdx', ++msgIdx);
  return m;
};

/* ==================== Trạng thái trò chơi ==================== */
let drop, obstacles, speed, interval, score;
let gameLoop, spawnLoop, playerName;

/* ------------------ Hàm tiện ích ------------------ */
const collide=(a,b)=>{
  const dx=(a.x+a.w/2)-(b.x+b.w/2),
        dy=(a.y+a.h/2)-(b.y+b.h/2),
        r =(a.w+b.w)*0.2;
  return dx*dx + dy*dy < r*r;
};
const spawnObstacle = () =>
  obstacles.push({x:Math.random()*MAX_X, y:-SIZE, w:SIZE, h:SIZE});
const escalate      = () => {
  speed += 0.5;
  if (interval > 400) {
    clearInterval(spawnLoop);
    interval -= 100;
    spawnLoop = setInterval(spawnObstacle, interval);
  }
};

/* ------------------ Vẽ và cập nhật ------------------ */
function draw() {
  ctx.clearRect(0,0,400,500);
  ctx.drawImage(bloodImg, drop.x, drop.y, drop.w, drop.h);
  obstacles.forEach(o=>ctx.drawImage(clotImg,o.x,o.y,o.w,o.h));
}
function update() {
  draw();
  obstacles.forEach((o,i)=>{
    o.y += speed;
    if (collide(drop,o)) return endGame();
    if (o.y > 500) {
      obstacles.splice(i,1);
      score++;
      scoreBox.textContent = `Điểm: ${score}`;
    }
  });
}
const startLoops = () => {
  gameLoop  = setInterval(update, 20);
  spawnLoop = setInterval(spawnObstacle, interval);
  setInterval(escalate, 5000);
};

/* ------------------ Khởi tạo ------------------ */
function resetState(){
  drop = {x:START_X, y:420, w:SIZE, h:SIZE};
  obstacles = [];
  score = 0;
  speed = 3;
  interval = 1400;
}

/* ------------------ Start / End game ------------------ */
function startGame(){
  playerName = document.getElementById('playerNameInput').value.trim() || 'Bạn';
  localStorage.setItem('playerName', playerName);
  startScr.style.display = 'none';
  bgMusic.play().catch(()=>{});
  resetState();
  startLoops();
}
function endGame(){
  clearInterval(gameLoop); clearInterval(spawnLoop);
  hitSound.currentTime = 0; hitSound.play();
  bgMusic.pause();
  gOverBox.style.display = 'flex';
  gOverBox.innerHTML = `
    <p style="color:yellow;font-size:32px">${playerName}, điểm: ${score}</p>
    <p>Cảm ơn bạn đã tham gia!</p>
    <p style="font-style:italic">${nextMsg()}</p>
    <button onclick="location.reload()">Chơi lại</button>`;
}

/* ------------------ Tự chạy nếu đã lưu tên ------------------ */
window.addEventListener('DOMContentLoaded',()=>{
  if(localStorage.getItem('playerName')){
    document.getElementById('playerNameInput').value =
      localStorage.getItem('playerName');
    startGame();
  }
});

/* ------------------ Điều khiển ------------------ */
// Keyboard
window.addEventListener('keydown',e=>{
  if(['ArrowLeft','a'].includes(e.key) && drop.x > 0)      drop.x -= 30;
  if(['ArrowRight','d'].includes(e.key) && drop.x < MAX_X) drop.x += 30;
});
// Swipe
let sX=null;
canvas.addEventListener('touchstart',e=>sX=e.touches[0].clientX,{passive:true});
canvas.addEventListener('touchend',e=>{
  if(sX===null) return;
  const dx = e.changedTouches[0].clientX - sX;
  if(Math.abs(dx)>30){
    dx>0 ? drop.x=Math.min(MAX_X,drop.x+30)
         : drop.x=Math.max(0,     drop.x-30);
  }
  sX=null;
},{passive:true});
// Mobile buttons
['touchstart','mousedown'].forEach(evt=>{
  document.getElementById('btnLeft').addEventListener(evt, e=>{
    e.preventDefault();
    if (drop.x > 0) drop.x -= 30;
    if (bgMusic.paused) bgMusic.play().catch(()=>{});
  },{passive:false});
  document.getElementById('btnRight').addEventListener(evt, e=>{
    e.preventDefault();
    if (drop.x < MAX_X) drop.x += 30;
    if (bgMusic.paused) bgMusic.play().catch(()=>{});
  },{passive:false});
});

// Nút bắt đầu
document.getElementById('startBtn').addEventListener('click', startGame);
</script>
</body>
</html>
